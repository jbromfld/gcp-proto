# Use Python 3.11 slim image as base
# docker build --platform linux/amd64 -t us-central1-docker.pkg.dev/gcp-poc-474818/rag-system/rag-etl:latest -f Dockerfile.etl .
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements file
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application files
COPY rag_etl_pipeline.py .
COPY rag_embeddings.py .
COPY rag_llm_abstraction.py .
COPY rag_service.py .
COPY rag_evaluation.py .
COPY elasticsearch_client.py .
COPY rag_etl_server.py .

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PORT=8080

EXPOSE 8080

# Start FastAPI server for ETL triggers (Cloud Run requires HTTP server)
CMD ["uvicorn", "rag_etl_server:app", "--host", "0.0.0.0", "--port", "8080", "--workers", "1"]